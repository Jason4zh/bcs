<!DOCTYPE html>
<html>
<head>
  <title>小球碰撞</title>
  <style>
    body { margin: 0; padding: 20px; font-family: Arial; }
    #simCanvas { border: 1px solid #ccc; }
    button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    #startBtn { background-color: #4CAF50; color: white; }
    #startBtn:hover { background-color: #45a049; }
    #startBtn:disabled { background-color: #cccccc; cursor: not-allowed; }
    .info-container { margin-top: 10px; display: flex; gap: 20px; }
    #killFeed { padding: 10px; border: 1px solid #ccc; height: 150px; width: 300px; overflow-y: auto; text-align: center; }
    #ballStats { padding: 10px; border: 1px solid #ccc; }
    #ballStats table { border-collapse: collapse; background-color: #fff; }
    #ballStats th, #ballStats td { border: 1px solid #eee; padding: 8px 12px; text-align: center; }
    #ballStats th { background-color: #f5f5f5; font-weight: bold; text-align: right; }
    .color-indicator { display: inline-block; width: 20px; height: 20px; border-radius: 50%; }
    .quantity-selector { display: inline-flex; align-items: center; margin: 5px; }
    .quantity-btn { width: 30px; height: 30px; background-color: #f0f0f0; border: 1px solid #ccc; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .quantity-btn:hover { background-color: #e0e0e0; }
    .quantity-btn:disabled { background-color: #f5f5f5; cursor: not-allowed; color: #999; }
    .quantity-input { width: 60px; height: 28px; text-align: center; border: 1px solid #ccc; border-left: none; border-right: none; font-size: 16px; }
  </style>
</head>
<body>
  <canvas id="simCanvas" width="900" height="900"></canvas>
  <div class="info-container">
    <div id="killFeed"></div>
    <div id="ballStats">
      <table>
        <tbody id="ballStatsTable"></tbody>
      </table>
    </div>
  </div>
  <div>
    <button id="startBtn">开始游戏</button>
    <div class="quantity-selector">
      <button id="decreaseBtn" class="quantity-btn">-</button>
      <input type="number" id="ballCountInput" class="quantity-input" value="6" min="1" max="20">
      <button id="increaseBtn" class="quantity-btn">+</button>
      <span style="margin-left: 10px;">小球数量</span>
    </div>
  </div>

  <script src="bcs.js"></script>
  <script>
    const canvas = document.getElementById('simCanvas');
    canvas.width = window.innerWidth - 100;
    canvas.height = window.innerHeight - 100;
    
    const simulator = new BallCollisionSimulator(canvas, {
      colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFBE0B', '#FF9F1C', '#E63946', '#A8DADC', '#1D3557']
    });

    const startBtn = document.getElementById('startBtn');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    const ballCountInput = document.getElementById('ballCountInput');

    function updateBallStats() {
      const tableBody = document.getElementById('ballStatsTable');
      tableBody.innerHTML = '';

      const sortedBalls = simulator.getBalls().sort((a, b) => b.mass - a.mass);
      const headers = ['编号', '颜色', '质量', '击杀数'];

      headers.forEach((header, headerIndex) => {
        const row = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = header;
        row.appendChild(th);
        
        sortedBalls.forEach((ball) => {
          const td = document.createElement('td');
          
          switch(headerIndex) {
            case 0:
              td.textContent = ball.id;
              td.style.fontWeight = 'bold';
              break;
            case 1:
              td.innerHTML = `<span class="color-indicator" style="background-color: ${ball.color};"></span>`;
              break;
            case 2:
              td.textContent = ball.mass;
              break;
            case 3:
              td.textContent = simulator.killCounts[ball.id] || 0;
              break;
          }
          
          row.appendChild(td);
        });
        
        tableBody.appendChild(row);
      });
    }

    simulator.onKill = (killInfo) => {
      const killFeedElement = document.getElementById('killFeed');
      const killEntry = document.createElement('div');
      killEntry.style.margin = '5px 0';
      killEntry.innerHTML = `
        <span style="color: ${killInfo.killerColor}; font-size: 40px;">●${killInfo.killerId}</span>
        击杀了
        <span style="color: ${killInfo.victimColor}; font-size: 40px;">●${killInfo.victimId}</span>
        ，剩余<span style="font-weight: bold">${killInfo.ballsNumber}</span>球。
      `;
      
      if (killFeedElement.firstChild) {
        killFeedElement.insertBefore(killEntry, killFeedElement.firstChild);
      } else {
        killFeedElement.appendChild(killEntry);
      }

      updateBallStats();
    };

    const t = (window.innerHeight - 100) * (window.innerWidth - 100) / 50000;

    startBtn.addEventListener('click', () => {
      const ballCount = parseInt(ballCountInput.value);
      
      if (ballCount < 1) {
        alert('小球数量必须至少为1');
        return;
      }
      
      simulator.reset();
      simulator.addBalls(ballCount);
      simulator.start();
      
      startBtn.disabled = true;
      decreaseBtn.disabled = true;
      increaseBtn.disabled = true;
      ballCountInput.disabled = true;
      
      updateBallStats();
    });

    decreaseBtn.addEventListener('click', () => {
      let currentValue = parseInt(ballCountInput.value);
      if (currentValue > 1) {
        ballCountInput.value = currentValue - 1;
      }
    });

    increaseBtn.addEventListener('click', () => {
      let currentValue = parseInt(ballCountInput.value);
      if (currentValue < 20) {
        ballCountInput.value = currentValue + 1;
      }
    });

    ballCountInput.addEventListener('change', () => {
      let value = parseInt(ballCountInput.value);
      if (isNaN(value) || value < 1) {
        ballCountInput.value = 1;
      } else if (value > 20) {
        ballCountInput.value = 20;
      }
    });

    const originalAnimate = simulator._animate;
    simulator._animate = function() {
      originalAnimate.call(this);
      updateBallStats();
    };

    const knife = new Image();
    knife.src = 'knife.png';
    simulator.setKnifeImage(knife);

    const heart = new Image();
    heart.src = 'heart.png';
    simulator.setHeartImage(heart);

    updateBallStats();
  </script>
</body>
</html>