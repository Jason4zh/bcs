<!DOCTYPE html>
<html>
<head>
  <title>小球碰撞 BCS</title>
  <style>
    body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
    #simCanvas { border: 1px solid #ccc; }
    button { margin: 5px; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
    #startBtn { background-color: #4CAF50; color: white; }
    #startBtn:hover { background-color: #45a049; }
    #startBtn:disabled { background-color: #cccccc; cursor: not-allowed; }
    #stopBtn { background-color: #f44336; color: white; }
    #stopBtn:hover { background-color: #d32f2f; }
    #addBallBtn { background-color: #2196F3; color: white; }
    #addBallBtn:hover { background-color: #0b7dda; }
    .info-container { margin-top: 10px; display: flex; gap: 20px; }
    #killFeed { padding: 10px; border: 1px solid #ccc; height: 150px; width: 300px; overflow-y: auto; text-align: center; }
    #ballStats { padding: 10px; border: 1px solid #ccc; }
    #ballStats table { border-collapse: collapse; background-color: #fff; }
    #ballStats th, #ballStats td { border: 1px solid #eee; padding: 8px 12px; text-align: center; }
    #ballStats th { background-color: #f5f5f5; font-weight: bold; text-align: right; }
    .color-indicator { display: inline-block; width: 20px; height: 20px; border-radius: 50%; }
    .quantity-selector { display: inline-flex; align-items: center; margin: 5px; }
    .quantity-btn { width: 30px; height: 30px; background-color: #f0f0f0; border: 1px solid #ccc; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .quantity-btn:hover { background-color: #e0e0e0; }
    .quantity-btn:disabled { background-color: #f5f5f5; cursor: not-allowed; color: #999; }
    .quantity-input { width: 60px; height: 28px; text-align: center; border: 1px solid #ccc; border-left: none; border-right: none; font-size: 16px; }
  </style>
</head>
<body>
  <canvas id="simCanvas" width="900" height="900"></canvas>
  <div class="info-container">
    <div id="killFeed"></div>
    <div id="ballStats">
      <table>
        <tbody id="ballStatsTable"></tbody>
      </table>
    </div>
  </div>
  <div>
    <button id="startBtn">开始</button>
    <div class="quantity-selector">
      <button id="decreaseBtn" class="quantity-btn">-</button>
      <input type="number" id="ballCountInput" class="quantity-input" value="6" min="1" max="20">
      <button id="increaseBtn" class="quantity-btn">+</button>
      <span style="margin-left: 10px;">初始小球数量</span>
    </div>
  </div>

  <script src="bcs.js"></script>
  <script>
    const canvas = document.getElementById('simCanvas');
    canvas.width = window.innerWidth - 100;
    canvas.height = window.innerHeight - 100;
    
    const simulator = new BallCollisionSimulator(canvas, {
      colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFBE0B']
    });

    const killCounts = {};
    let initialBallCount = 0;
    let gameStarted = false;

    function updateBallStats() {
      const tableBody = document.getElementById('ballStatsTable');
      tableBody.innerHTML = '';

      const sortedBalls = simulator.getBalls().sort((a, b) => b.mass - a.mass);
      const headers = ['编号', '颜色', '质量', '击杀数'];

      headers.forEach((header, headerIndex) => {
        const row = document.createElement('tr');
        const th = document.createElement('th');
        th.textContent = header;
        row.appendChild(th);
        
        sortedBalls.forEach((ball) => {
          if (killCounts[ball.id] === undefined) {
            killCounts[ball.id] = 0;
          }

          const td = document.createElement('td');
          
          switch(headerIndex) {
            case 0:
              td.textContent = ball.id;
              td.style.fontWeight = 'bold';
              break;
            case 1:
              td.innerHTML = `<span class="color-indicator" style="background-color: ${ball.color};"></span>`;
              break;
            case 2:
              td.textContent = ball.mass;
              break;
            case 3:
              td.textContent = killCounts[ball.id];
              break;
          }
          
          row.appendChild(td);
        });
        
        tableBody.appendChild(row);
      });
    }

    simulator.onKill = (killInfo) => {
      const killFeedElement = document.getElementById('killFeed');
      const killEntry = document.createElement('div');
      killEntry.style.margin = '5px 0';
      killEntry.innerHTML = `
        <span style="color: ${killInfo.killerColor}; font-size: 40px;">●${killInfo.killerId}</span>
        击杀了
        <span style="color: ${killInfo.victimColor}; font-size: 40px;">●${killInfo.victimId}</span>
        ，剩余<span style="font-weight: bold">${killInfo.ballsNumber}</span>球。
        ${killInfo.ballsNumber === 1 ? `<br><span style="color: ${killInfo.killerColor}; font-size: 40px;">●${killInfo.killerId}</span> 获胜！` : ''}
      `;
      
      if (killFeedElement.firstChild) {
        killFeedElement.insertBefore(killEntry, killFeedElement.firstChild);
      } else {
        killFeedElement.appendChild(killEntry);
      }

      if (killInfo.ballsNumber === 5 && initialBallCount > 5) {
        const interval = setInterval(() => {
          const size = simulator.reduceBoxSize("box", 1);
          if (size && Math.min(size[0], size[1]) <= 250) {
            clearInterval(interval);
            simulator.placeKnifeRandomly();
            simulator.placeHeartRandomly();
          }
        }, 20);
      }

      const killerBall = simulator.getBalls().find(ball => ball.id === killInfo.killerId);
      if (killerBall) {
        killCounts[killerBall.id] = (killCounts[killerBall.id] || 0) + 1;
      }

      if (killInfo.ballsNumber === 1) {
        const winner = simulator.getBalls()[0];
        const winnerKills = killCounts[winner.id] || 0;
        setTimeout(() => {
          alert(`游戏结束！\n\n获胜者：小球 #${winner.id}\n剩余血量：${winner.mass}\n击杀数：${winnerKills}`);
        }, 500);
      }

      updateBallStats();
    };

    const t = (window.innerHeight - 100) * (window.innerWidth - 100) / 50000;

    const startBtn = document.getElementById('startBtn');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    const ballCountInput = document.getElementById('ballCountInput');

    startBtn.addEventListener('click', () => {
      if (gameStarted) return;
      
      const ballCount = parseInt(ballCountInput.value);
      
      if (ballCount < 1) {
        alert('小球数量必须至少为1');
        return;
      }
      
      initialBallCount = ballCount;
      gameStarted = true;
      
      startBtn.disabled = true;
      decreaseBtn.disabled = true;
      increaseBtn.disabled = true;
      ballCountInput.disabled = true;
      
      simulator.reset();
      
      for (let i = 0; i < ballCount; i++) {
        const color = `rgb(${Math.round(Math.random() * 255)}, ${Math.round(Math.random() * 255)}, ${Math.round(Math.random() * 255)})`;
        
        const ballId = simulator.addBall({
          radius: 60,
          mass: 6,
          vx: (Math.random() * t / 2) + t / 2,
          vy: (Math.random() * t / 2) + t / 2,
          color: color
        });
        
        killCounts[ballId] = 0;
      }
      
      updateBallStats();
      simulator.start();
    });

    decreaseBtn.addEventListener('click', () => {
      let currentValue = parseInt(ballCountInput.value);
      if (currentValue > 1) {
        ballCountInput.value = currentValue - 1;
      }
    });

    increaseBtn.addEventListener('click', () => {
      let currentValue = parseInt(ballCountInput.value);
      if (currentValue < 20) {
        ballCountInput.value = currentValue + 1;
      }
    });

    ballCountInput.addEventListener('change', () => {
      let value = parseInt(ballCountInput.value);
      if (isNaN(value) || value < 1) {
        ballCountInput.value = 1;
      } else if (value > 20) {
        ballCountInput.value = 20;
      }
    });

    const originalAnimate = simulator._animate;
    simulator._animate = function() {
      originalAnimate.call(this);
      updateBallStats();
    };

    const knife = new Image();
    knife.src = 'knife.png';
    simulator.setKnifeImage(knife);

    const heart = new Image();
    heart.src = 'heart.png';
    simulator.setHeartImage(heart);

    updateBallStats();
  </script>
</body>
</html>